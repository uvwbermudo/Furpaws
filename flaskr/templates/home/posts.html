{% extends 'base.html' %}
{% block title %} FurPaws - Home {% endblock %}
{% block body_content %}
<div class="main-feed">
  <div classs="main-feed-posts">
    {% for details in post %}
    <br>
    <br>
    <div class="card">
      <div class="card-header">
        {{details.post_id}}
      </div>
      <div class="card-body">
        <div class="card-text">
          @{{details.author_tag}}
          {{details.post_content}}
          <h2>
            {{ details.date_posted.strftime("%d,%b %Y").lower()}}
          </h2>
        </div>
        {% if details.author_tag == current_user.tag %}
          <button type="button" class="btn btn-danger mb-3" data-bs-toggle="modal" data-bs-target="#deletePostModal{{details.post_id}}">
            Delete
          </button>
          <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#editPostModal{{details.post_id}}" data-bs-whatever="@getbootstrap" type="button">
            Edit
          </button>
        {% endif %}
        <button class="btn btn-secondary mb-3" data-bs-toggle="modal" data-bs-target="#sharePostModal{{details.post_id}}">
          Share 
        </button><br>
        <u>Shares</u> {{post.sharedposts|length}}<br>
        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#viewCommentsModal{{details.post_id}}">
          View Comments
        </button>
      </div>
      <div class="card-footer" style="background-color:white; position:flex;">
        {% if current_user.tag in details.likes|map(attribute="author_tag")|list %}
          {% for like in details.likes %}
            {% if current_user.tag == like.author_tag %}
              <a href="/posts/unlike-post/{{like.id}}/{{like.post_liked}}"><img src="../../static/img/like_filled.png" width="35px" height="33px"></a>
            {% endif %}
          {% endfor %}
        {% else %}
          <a href="/posts/like-post/{{details.post_id}}"><img src="../../static/img/like_unfilled.png" width="35px" height="33px"></a>
        {% endif %}
        {{ details.likes|length }}
      </div>
    </div>
 
    <!-- DELETE POST MODAL  -->
    <div class="modal fade" id="deletePostModal{{details.post_id}}" tabindex="-1" aria-labelledby="deletePostModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="deleteModalLabel">
              Delete Post
            </h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this post?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
            <form action="{{url_for('home.delete_post', post_id=details.post_id)}}" method="POST">
              {{form.csrf_token}}
              <input type="submit" class="btn btn-danger" value="Delete">
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- EDIT POST MODAL -->
    <div class="modal fade" id="editPostModal{{details.post_id}}" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="editPostModalLabel">
              Edit Post
            </h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
            </button>
          </div>
          <div class="modal-body">
            <form action="/posts/update/{{details.post_id}}" method="POST">
              <textarea class="form-control" name="post_description" id="post_description" placeholder="{{details.post_content}}" required>{{details.post_content}}</textarea>
          </div>
          <h5 align="left">
            Image Preview:
          </h5>
          <div class="card">
            <div class="card-body d-flex flex-wrap justify-content-start">
              {% for photo in details.photos %}
                  <div class="image-preview d-flex justify-content-center position-relative">
                    <img src="{{photo.photo_url}}" alt="Image">
                    <span class="position-absolute">&times;</span>
                  </div>
              {% endfor %}
            </div>
          </div>
          <div class="modal-footer">
            <label for="add_photos" class="add-post-btns" name="add_photos"><img src="../../static/img/image-line.png"/>
              Add Photos
            </label>
  
            <label for="add_videos" name="add_videos" class="add-post-btns">
              <img src="../../static/img/movie-line.png">
              Add Videos
            </label>
            <input type="file" name="files[]" multiple="true" id="add_photos" accept="image/png, image/jpg, image/jpeg" onclick="imageTooLargeAlert();" hidden>
        <input type="file" name="add_videos" multiple="true" id="add_videos" accept="video/mp4" onclick="videoTooLargeAlert();"hidden> Â 
            {{edit_form.csrf_token}}
            {{edit_form.edit_post_button(class="submit-post")}}</form>
          </div>
        </div>
      </div>
    </div>

    <!-- SHARE POST MODAL -->
    <div class="modal fade" id="sharePostModal{{details.post_id}}" tabindex="-1" aria-labelledby="sharePostModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="shareModalLabel">
              Share Post
            </h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to share this post?
          </div>
          <div class="modal-footer">
            <form action="{{url_for('home.share_post', post_id=details.post_id)}}" method="POST">
              {{form.csrf_token}}
              <input type="submit" class="submit-post" value="Share Post">
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- COMMENT MODALS  -->
    <div class="modal fade" id="viewCommentsModal{{details.post_id}}" tabindex="-1" role="dialog" aria-labelledby="viewCommentsModalLabel{{details.post_id}}" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <p class="modal-title fs-5" id="viewCommentsModalLabel{{details.post_id}}">
              @{{details.author_tag}}'s post
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
            </button>
          </div>
          <div class="card mt-3 mb-3 p-3">
            "{{details.post_content}}"
          </div>
          <div class="modal-body bg-info bg-opacity-10" >
            <div class="collapse" id="comments-{{details.post_id}}">
              <div class="card">
                <div class="card-body">
                  {% if details.author_tag == current_user.tag %}
                    {% for comments in details.comments %}
                      {% if comments.author_tag == current_user.tag %}
                        <div class="card text-start">
                          <div class="card-body">
                            <a href="#">{{comments.author_tag}}</a>
                            {{comments.comment_content}}
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#editCommentModal{{comments.comment_id}}">
                              Edit
                            </button>
                            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCommentModal{{comments.comment_id}}">
                              Delete  
                            </button>
                          </div>
                        </div>
                        <br>
                      {% else %}
                        <div class="card">
                          <div class="card-body">
                            <a href="#">{{comments.author_tag}}</a>
                            {{comments.comment_content}}
                            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCommentModal{{comments.comment_id}}">
                              Delete
                            </button>
                          </div>
                        </div>
                        <br>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    {% for comments in details.comments %}
                        {% if comments.author_tag == current_user.tag %}
                          <div class="card">
                            <div class="card-body">
                              <a href="#">{{comments.author_tag}}</a>
                              {{comments.comment_content}}
                              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#editCommentModal{{comments.comment_id}}">
                                Edit
                              </button>
                              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCommentModal{{comments.comment_id}}">
                                Delete  
                              </button>
                            </div>
                          </div>
                          <br>
                        {% else %}
                          <div class="card">
                            <div class="card-body">
                              <a href="#">{{comments.author_tag}}</a>
                              {{comments.comment_content}}
                            </div>
                          </div>
                          <br>
                        {% endif%}
                    {% endfor %}
                  {% endif %}
                </div>
              </div>
            </div>
            <p class="card-text">
              {% if details.comments|length > 0 %}
                <a data data-bs-toggle="collapse" href="#comments-{{details.post_id}}" role="button">
                  <small>
                    View {{details.comments|length}} Comments
                  </small>
                </a>
              {% else %}
                <small class="text-muted">No comments!</small>
              {% endif %}
            </p>
          </div>
          <div class="modal-footer">
            <form class="input-group mb-3" method="POST" action="/posts/create-comment/{{details.post_id}}">
            <textarea class="form-control" style="width: 115px;" id="comment_textbox" name="comment_textbox" placeholder="Say something about this post..."></textarea>
            {{form.csrf_token}}
            <br><pre> </pre>
            <button type="submit" 
            style=
            "border-radius: 10px;
            width:170px;
            padding: 3px;
            border:none;
            outline:none;
            background-color: rgb(109, 216, 235);
            color: white;">
              Comment
            </button>
            </form>
          </div>
          <br>

        </div>
      </div>
    </div>
    {% for comments in details.comments %}
    <div class="modal fade" id="editCommentModal{{comments.comment_id}}" tabindex="-1" role="dialog" aria-labelledby="editCommentModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="editCommentModalLabel">
              Edit Comment
            </h1>
            <button type="button" class="btn-close" data-bs-toggle="modal" data-bs-target="#viewCommentsModal{{details.post_id}}"></button>
          </div>
          <div class="modal-body">
            <form action="/posts/update-comment/{{comments.comment_id}}/{{comments.post_commented}}" method="POST">
              <textarea class="form-control" name="edit_comment_textbox" id="edit_comment_textbox" placeholder="{{comments.comment_content}}" required>{{comments.comment_content}}</textarea>
          </div>
          <div class="modal-footer">
            {{edit_comment_form.csrf_token}}
            {{edit_comment_form.edit_comment_button(class="submit-post")}}</form>
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#viewCommentsModal{{details.post_id}}" style="width:100%">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="deleteCommentModal{{comments.comment_id}}" tabindex="-1" role="dialog" aria-labelledby="deleteCommentModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="deleteCommentModalLabel">
              Delete Comment
            </h1>
            <button type="button" class="btn-close" data-bs-toggle="modal" data-bs-target="#viewCommentsModal{{details.post_id}}"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this comment?
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#viewCommentsModal{{details.post_id}}">
              Cancel
            </button>
            <form action="{{url_for('home.delete_comment_on_visited_post', comment_id=comments.comment_id, post_id=comments.post_commented)}}" method="POST">
              {{form.csrf_token}}
              <input type="submit" class="btn btn-danger" value="Delete">
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    {% endfor %}
  </div>
</div>
{% endblock %}